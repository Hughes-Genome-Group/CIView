<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Filtering Example</title>
    <meta charset="UTF-8">
    	
 <link rel="stylesheet" type="text/css" href="../../MLVPanel/css/jquery-ui-bootstrap/jquery-ui-1.10.3.custom.css">
 <!--<link rel="stylesheet" type="text/css" href="../../CIView/bootstrap-4.10/css/bootstrap.min.css">-->
    <link rel="stylesheet" type="text/css" href="css/dc.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/ciview.css"/>
     <link rel="stylesheet" type="text/css" href="css/gridstack.css"/>
  
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">

    	

</head>
<body>

<div style="position:absoloute;width:40%;height:500px" id= "filter-div">
                 

                
</div>    

<div id="image-table"  style="position:absolute;width:55%;left:40%;top:30px;bottom:5px"></div>   





<script type="text/javascript" src="src/vendor/jquery.min.js"></script>
<script type="text/javascript" src="src/vendor/jquery-ui.min.js"></script>


<!--<script type="text/javascript" src="../MLV/lanceotron/dist/MLVPanel_custom.js"></script>-->
<!--<script type="text/javascript" src="src/vendor/d3.js"></script>-->
<!--<script type="text/javascript" src="src/vendor/crossfilter.js"></script>-->
<!--<script type="text/javascript" src="src/vendor/dc.min.js"></script>-->


<script type="module">
import {crossfilter} from "./src/vendor/crossfilter.js"
import {dc} from "./src/vendor/dc.js";
import {d3} from "./src/vendor/d3.js";
import {MLVBarChart,MLVRingChart,MLVScatterPlot} from "./src/graphs.js";
import {MLVImageTable,MLVImageTableControls} from "./src/image_table.js";
import {DataView} from "./src/vendor/slick.dataview.js";
import {FilterPanel,AddChartDialog} from "./src/graphs.js";
import {CIView} from "./src/ciview.js";
   





// set crossfilter



 


$(function(){
  $.ajax({
    url:"/genes/meths/hg19/get_view_set_full/230",
    dataType:"json"
  }).done(function(data){
      console.log(data);
      
     
     
      /*let panel_config ={
				allow_user_drag:true,
				allow_user_zoom:true,
				allow_user_resize:true,
				allow_user_move:true,
				width:500,
				height:200
			}
		let tracks=data['tracks']
		let peak_url =tracks[2].url.replace(".bb","_wid.bb")
		let track_config=[
		
          {url:"/genes/meths/hg19/get_genes",color:"#000000",short_label:"Ref Genes",type:"custom_annotation",format:"feature"},
          {url:peak_url,color:"#FF5733",short_label:"peaks",track_id:"peaks"},
          {url:tracks[0].url,color:"#808080",short_label:"Original wig",track_id:"wig_file",discrete:true,group:"g1",scale:"dynamic",height:100},
          {url:tracks[1].url,color:"#DC143C",short_label:"Smoothing",scale_link_to:"wig_file",display:"line",discrete:true,group:"g1"}


		];
		let panel = new MLVPanel(track_config,panel_config);

		panel.getDiv().css({"background-color":"white","border":"1px solid black",right:"5px",bottom:"5px"}).appendTo("body");
		panel.addRulerTrack();
		panel.addLegend();
		
		panel.setTrackFeatureFilter("peaks",function(feature){
		  return dv.getItemById(parseInt(feature.name));
		});
	
		var colorRange = ['red', 'green']
        
       var range = d3.scaleLinear().range(colorRange).domain([0,1]);
		panel.setTrackColorFunction("peaks",function(feature){
		   return range(dv.getItemById(parseInt(feature.name)).field11);
		});
		
	
		panel.update("chr1",100000000,200000000);

		
     */
     let config={
		filter_div:"filter-div",
		table_div:"image-table",
		data:data.view_data,
		listener:function(){
			
		},
		graph_groups:[],
		image_base_url:"http://martindev1.molbiol.ox.ac.uk/data/hg19/view_sets/230/thumbnails/tn"
     }


      for (let group_name in data.data.field_information ){
      	
      	let group = data.data.field_information[group_name];
      	if (group_name==="Clustering"){
      		let item={name:"Clustering",graph_size:null,graphs:[]};
      		for (let chart_name in group){
      			item.graphs.push({type:"wgl_scatter_plot",name:chart_name,params:group[chart_name]});
      			
      		}
      		config.graph_groups.push(item);

      	}
      	if (group_name==="Peak Stats"){
      		let item={name:"Peak Stats",graph_size:null,graphs:[]};
      		for (let chart_name in group){
      			item.graphs.push({type:"bar_chart",name:chart_name,params:group[chart_name]});
      		}
      		item.graphs.push({type:"row_chart",name:"tagsg",params:"tags"});
      		config.graph_groups.push(item);
      		
      	}
      	if (group_name==="Annotations"){
      		let item={name:"Annotations",graph_size:null,graphs:[]}
      		for (let chart_name in group){
      			item.graphs.push({type:"ring_chart",name:chart_name,params:group[chart_name]});
      		}
      		config.graph_groups.push(item);

      	}
      	if (group_name==="Machine Learning"){
      		let item={name:"Machine Learning",graph_size:null,graphs:[]}
      		
      		for (let chart_name in group){
      			item.graphs.push({type:"bar_chart",name:chart_name,params:group[chart_name]})
      		}
      		config.graph_groups.push(item);
      	}
      
      }

     let civ = new CIView(config);
     let a = function(d){
     	if (d.field11>0.5){
     		return "Peak";
     	}
     	if (d.field12>0.5){
     		return "Noise";
     	}
     	return "Mixed"
     }
     civ.filter_panel.addChart("ring_chart",a);
     //civ.filter_panel.charts['filter-chart-4'].changeFields(["field4","field6"]);
     let ff = function(d){
     	return d>1000;
     };
    /* let filter = civ.data_view.filters[0];
     filter.active=true;
     filter.operand=">";
     filter.value=1000;
     civ.data_view.filterData();
     */
     let cols=[
		{field:"field6",name:"Peak Area",datatype:"double"},
		{field:"field5",name:"Peak Height",datatype:"double"},
		{field:"field4",name:"Peak Width",datatype:"double"},
     ];

     new AddChartDialog(cols,function(data){
     	civ.filter_panel.addChart(data.type,data.param,data.label,"sss",{
     		x:0,
     		y:0,
     		height:3,
     		width:4
     	})
     });
     let arr = [];
     for (let i=0;i<30;i++){
     	arr.push({tags:"peak"})
     }
     //civ.filter_panel.addRecords(arr);
     dc.redrawAll();


     
     
    
   
   
   
      function updateTable(list,first){
        dv.setItems(list);
        $("#total-num").text(list.length);
        it.show(1);
        if (!first){
          panel.update();
        }
      }

      // civ.filter_panel.addCustomFilter("id_filter","id",ff,true);

   
     
      
     

     /*let f=new MLVBarChart(ndx,"field6","bar-chart","Peak Area")
      f.setUpdateListener(updateTable);
      new MLVScatterPlot(ndx,["field9","field10"],"scatter-plot","tSNE").setUpdateListener(updateTable);
      new MLVRingChart(ndx,"field1","ring-chart","Cpg Islands").setUpdateListener(updateTable);
      let a=new MLVBarChart(ndx,"field11","peak-score","Peak Score")
      a.setUpdateListener(updateTable);
      
     // f.setRange(null,2000);
     // f.setBinNumber(4);
     */
   /*  civ.addFilter("id",function(id){
     	if (id>1000){
     		return false;
     	}
     	return true;
     },"the_filter");
     civ.removeFilter("the_filter");*/
     // f.changeXScale(1000);


    
     //civ.addFilterSet("sdsdsd",[{"name":"g2h2gg",params:"field13",type:"row_chart"}],pop);
     //civ.removeFilterSet("Clustering",true);
     //civ.addGraph("Clustering","bar_chart","field6","Added");
     //civ.changeGraphFields("PCA",["field9","field10"]);

   
    
    
      



  });
})

</script>

</div>
</body>
</html>

